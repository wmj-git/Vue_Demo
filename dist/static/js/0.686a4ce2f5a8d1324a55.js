webpackJsonp([0],{"1WoT":function(e,t,o){"use strict";(function(e){t.b=function(t,o,n,r){var i={type:"typeName",titleKey:"id",iconUrl:""};for(var l in i)o[l]&&(i[l]=o[l]);var a=t||"",s=new ol.format.EsriJSON,c=new ol.source.Vector({loader:function(t,o,n){var r=a+"/query/?f=json&returnGeometry=true&spatialRel=esriSpatialRelIntersects&geometry="+encodeURIComponent('{"xmin":'+t[0]+',"ymin":'+t[1]+',"xmax":'+t[2]+',"ymax":'+t[3]+',"spatialReference":{"wkid":4490}}')+"&geometryType=esriGeometryEnvelope&inSR=4490&outFields=*&outSR=4490";c.getFeatures().length>0?console.log(c.getFeatures()):e.ajax({url:r,async:!0,dataType:"json",success:function(e){if(e.error)console.log(e.error.message+"\n"+e.error.details.join("\n"));else{var t=s.readFeatures(e,{featureProjection:n});if(t.length>0){var o=[];t.forEach(function(e){e.setId(i.type+"_"+e.get(i.titleKey));var t=e.getKeys(),n={};t.forEach(function(t){"geometry"===t||(n[t]=e.get(t))}),n.coordinates=e.get("geometry").getCoordinates(),e.set("featureData",n),o.push(n)}),console.log("features2"),console.log(o),c.addFeatures(t)}}}})},strategy:ol.loadingstrategy.tile(ol.tilegrid.createXYZ({tileSize:512})),wrapX:!1}),p=new ol.source.Cluster({distance:r,source:c});var u={};return{layer:new ol.layer.Vector({name:i.type+"_layer",layer_type:"Cluster",source:p,style:function(e){var t,o=e.get("features").length,r=u[o];if(o>1)r||(r=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,28],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.8,scale:1.28,color:n,src:"../../static/image/cluster.png"}),text:new ol.style.Text({text:o.toString(),fill:new ol.style.Fill({color:"#fff"})})}),u[o]=r);else{var l=e.get("features")[0];t=l.get(i.titleKey),r=new ol.style.Style({image:new ol.style.Icon({anchor:[0,0],anchorXUnits:"fraction",anchorYUnits:"pixels",scale:.4,src:i.iconUrl+""}),text:new ol.style.Text({text:t+"",offsetX:12,offsetY:-8,fill:new ol.style.Fill({color:"#fff"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.6)",width:4})})})}return r}}),vectorSource:c,clusterSource:p}},t.d=l,t.a=a,t.c=s;var n=o("IcnI");function r(e){var t=Math.abs(e),o=Math.floor(t);return o+"°"+Math.floor(60*(t-o))+"'"+Math.round(3600*(t-o)%60)+'"'}function i(e,t){var o=null;switch(t.type){case"1":o=new ol.style.Style({stroke:new ol.style.Stroke({width:t.strokeWidth,color:JSON.parse(t.strokeColor)}),fill:new ol.style.Fill({color:JSON.parse(t.fillColor)}),text:new ol.style.Text({text:e[t.titleKey]?e[t.titleKey]+"":"",offsetX:0,offsetY:-28,fill:new ol.style.Fill({color:"#fff"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.6)",width:4})})});break;case"2":o=new ol.style.Style({text:new ol.style.Text({text:e[t.titleKey]?e[t.titleKey]+"":"",fill:new ol.style.Fill({color:JSON.parse(t.fillColor)}),stroke:new ol.style.Stroke({color:JSON.parse(t.strokeColor),width:t.strokeWidth})})})}return o}function l(e,t,o){var n=[],r=null,l={type:"layerName",geomType:"Point"};for(var a in l)t[a]&&(l[a]=t[a]);var s={type:"",titleKey:"id",strokeWidth:2,strokeColor:"[255, 0, 0, 1.0]",fillColor:"[0, 0, 255, 1.0]"};for(var c in s)o[c]&&(s[c]=o[c]);r=new ol.source.Vector({wrapX:!1});for(var p=0;p<e.length;++p){if("Point"===l.geomType){var u=[e[p].gpsLongitude,e[p].gpsLatitude];n[p]=new ol.Feature({geometry:new ol.geom.Point(u),featureData:e[p]})}else if("Text"===l.geomType){var y=[e[p].gpsLongitude,e[p].gpsLatitude];n[p]=new ol.Feature({geometry:new ol.geom.Point(y),featureData:e[p]}),n[p].setStyle(i(e[p],s))}else if("LineString"===l.geomType){var f=e[p].coordinates?e[p].coordinates:[];n[p]=new ol.Feature({geometry:new ol.geom.LineString(f),featureData:e[p]}),n[p].setStyle(i(e[p],s))}else if("Polygon"===l.geomType){var h=e[p].coordinates?e[p].coordinates:[];n[p]=new ol.Feature({geometry:new ol.geom.Polygon(h),featureData:e[p]}),n[p].setStyle(i(e[p],s))}else if("Circle"===l.geomType){var m=[e[p].gpsLongitude,e[p].gpsLatitude],d=e[p].radius?e[p].radius:10,g=new ol.geom.Circle(ol.proj.transform(m,"EPSG:4326","EPSG:3857"),d,"XY").transform("EPSG:3857","EPSG:4326");n[p]=new ol.Feature({geometry:g,featureData:e[p]}),n[p].setStyle(i(e[p],s))}n[p].setId(l.type+"_"+e[p].id)}return r.addFeatures(n),{features:n,source:r,layer:new ol.layer.Vector({name:l.type+"_layer",layer_type:"Layer",source:r})}}function a(e,t,o,n){var r={type:"typeName",titleKey:"id",iconUrlKey:"iconUrl"};for(var i in r)t[i]&&(r[i]=t[i]);for(var l=[],a=0;a<e.length;++a){var s=[e[a].gpsLongitude,e[a].gpsLatitude];l[a]=new ol.Feature({geometry:new ol.geom.Point(s),featureData:e[a]}),l[a].setId(r.type+"_"+e[a].id)}var c=new ol.source.Cluster({distance:n,source:new ol.source.Vector({features:l})});var p={};return{features:l,source:c,layer:new ol.layer.Vector({name:r.type+"_layer",layer_type:"Cluster",source:c,style:function(e){var t,n=e.get("features").length,i=p[n];if(n>1)i||(i=new ol.style.Style({image:new ol.style.Icon({anchor:[.5,28],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.8,scale:1.28,color:o,src:"../../static/image/cluster.png"}),text:new ol.style.Text({text:n.toString(),fill:new ol.style.Fill({color:"#fff"})})}),p[n]=i);else{var l=e.get("features")[0];t=l.get("featureData"),i=new ol.style.Style({image:new ol.style.Icon({anchor:[32,62],anchorXUnits:"pixels",anchorYUnits:"pixels",scale:.4,src:t[r.iconUrlKey]+""}),text:new ol.style.Text({text:t[r.titleKey]+"",offsetX:0,offsetY:-32,fill:new ol.style.Fill({color:"#fff"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.6)",width:4})})})}return i}})}}function s(e){this.el=e,this.resolutions=[.00059486525145757,.000297432625728785,.00015228550437313792,7614275218656896e-20,3807137609328448e-20,1903568804664224e-20,951784402332112e-20,475892201166056e-20,237946100583028e-20,118973050291514e-20,5.9486525145757e-7,2.97432625728785e-7],this.map=null,this.view=null,this.Info=null,this.InfoOverlay=null,this.xfsMarker=null,this.xfsExptionObj=null,this.xfsExptionOverlays=[],this.fireObj=null,this.fireOverlays=[],this.personMarker=null,this.personLine=null,this.coordinate_container=null,this.coordinate_content=null,this.coordinate_closer=null,this.coordinate_overlay=null,this.measureSource=null,this.measureVector=null,this.helpTooltip_Overlays=[],this.measureTooltip_Overlays=[],this.sketch=null,this.helpTooltipElement=null,this.helpTooltip=null,this.measureTooltipElement=null,this.measureTooltip=null,this.continuePolygonMsg="测量面积",this.continueLineMsg="测量距离",this.measure_draw=null}function c(e){var t=e.coordinate;console.log(t),appData.map.scopeFn([{id:"1",lng:t[0],lat:t[1],radius:100}]),appData.map.map.un("click",c)}s.prototype.init=function(t,o){var n=this,r=this.resolutions;this.view=new ol.View({resolutions:r,center:t,zoom:0,maxZoom:19,minZoom:0,projection:"EPSG:4326"}),this.map=new ol.Map({controls:ol.control.defaults({attribution:!1,zoom:!1,rotate:!0}).extend([]),target:n.el,layers:o,view:n.view}),this.map.on("moveend",function(e){var t=e.map,o=t.getView().calculateExtent(t.getSize()),r=(ol.extent.getCenter(o),n.view.getZoom()),i=t.getLayers().getArray();r>6?i.forEach(function(e){var t=e.getSource();"Cluster"===e.get("layer_type")&&t.setDistance(0)}):i.forEach(function(e){var t=e.getSource();"Cluster"===e.get("layer_type")&&t.setDistance(50)})}),e("body").append('<div id="em_ol_info" class="em-tooltip em-tooltip-static" style="z-index: 800"></div>'),this.Info=document.getElementById("em_ol_info"),this.InfoOverlay=new ol.Overlay({element:this.Info,positioning:"bottom-center",stopEvent:!1,offset:[6,-32],autoPan:!0,autoPanAnimation:{duration:100}}),this.map.addOverlay(this.InfoOverlay),this.map.on("pointermove",this.InfoPointermoveFn),this.map.on("click",this.InfoClickFn),this.measureSource=new ol.source.Vector,this.measureVector=new ol.layer.Vector({source:this.measureSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.4)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#ffcc33"})})})}),this.map.addLayer(this.measureVector)},s.prototype.viewFn=function(e,t){"none"===t?this.view.animate({zoom:e}):this.view.animate({center:t,zoom:e,duration:100})},s.prototype.xfsMarkerFn=function(t){var o=this,n=this,r=t;this.xfsMarker&&(this.map.removeLayer(this.xfsMarker.layer),this.clearXfsExptionOverlayFn());for(var i=0;i<r.length;i++)r[i].lng=r[i].googleLang,r[i].lat=r[i].googleLat,28===r[i].hydrantAvailableState?r[i].iconUrl="images/hybrant_mark_ok.png":29===r[i].hydrantAvailableState?r[i].iconUrl="images/hybrant_mark_success1.png":31===r[i].hydrantAvailableState?r[i].iconUrl="images/hybrant_mark_success3.png":r[i].id<=465?function(){r[i].iconUrl="images/hybrant_mark_success2.gif",e("body").append('<img id="xfs'+t[i].id+'" src="images/hybrant_mark_success2.gif" style="width:28px;height:34px;"/>');var l=new ol.Overlay({id:"xfs_"+r[i].id,position:[r[i].lng,r[i].lat],element:document.getElementById("xfs"+t[i].id),className:"xfs-overlay"});l.set("overlayData",r[i]),o.xfsExptionOverlays.push(l),o.map.addOverlay(l),e(l.getElement()).on("click",function(){var e=l.get("overlayData");n.infoFn({type:"xfs",content:e,lng:e.googleLang,lat:e.googleLat})}).on("mouseover",function(){e(this).css("cursor","pointer")})}():r[i].iconUrl="images/hybrant_mark_success2.png";this.xfsMarker=a(r,{type:"xfs",titleKey:"id",iconUrlKey:"iconUrl"},"images/cluster0.png",50),this.map.addLayer(this.xfsMarker.layer)},s.prototype.personMarkerFn=function(e){var t=e;console.log(t);for(var o=0;o<t.length;o++){var n=t[o].axis;t[o].id=t[o].modelName,t[o].lng=n[0],t[o].lat=n[1],t[o].iconUrl="images/men.png"}this.personMarker&&this.map.removeLayer(this.personMarker.layer),this.personMarker=a(t,{type:"person",titleKey:"name",iconUrlKey:"iconUrl"},"images/men.png",0),this.map.addLayer(this.personMarker.layer)},s.prototype.personLineFn=function(e){var t=e;if(console.log(t),!(e.length<=0)){for(var o={id:"",coordinates:[]},n=[],r=0;r<t.length;r++)n.push([t[r].googleLang,t[r].googleLat]);o.id=t[0].time,o.accountNo=t[0].accountNo,o.coordinates=n,this.personLine&&this.map.removeLayer(this.personLine.layer),this.personLine=l([o],{type:"line",geomType:"LineString"},{titleKey:"accountNo",strokeWidth:2,strokeColor:[0,255,0,1],fillColor:[0,0,255,1]}),this.map.addLayer(this.personLine.layer)}},s.prototype.scopeFn=function(e){var t=e;if(console.log(t),!(e.length<=0)){var o=[],n={id:"1",lng:0,lat:0,radius:0};t.forEach(function(e){for(var t in n)n[t]=e[t];o.push(n)}),this.scope&&this.map.removeLayer(this.scope.layer),this.scope=l(o,{type:"scope",geomType:"Circle"},{titleKey:"name",strokeWidth:2,strokeColor:[0,255,0,1],fillColor:[0,0,255,.4]}),this.map.addLayer(this.scope.layer)}},s.prototype.scopeToolFn=function(){this.scope&&this.map.removeLayer(this.scope.layer),this.map.on("click",c)},s.prototype.InfoClickFn=function(t){console.log(t);var o=n.a.getters["scene/type"];if(window[o]){var r=window[o].Info,i=t.map.forEachFeatureAtPixel(t.pixel,function(e){return e});if(i)if(console.log(i),e(".em_detail_window").addClass("addWidth"),i.get("features")&&1===i.get("features").length)i.get("features")[0].getId().split("_");else{if(!i.get("featureData"))return;i.getId().split("_")}else e(r).hide()}},s.prototype.InfoPointermoveFn=function(t){var o=null,r=n.a.getters["scene/type"];if(window[r]){var i=(o=window[r]).Info;if(t.dragging)e(i).hide();else{var l=t.map.getEventPixel(t.originalEvent),a=t.map.hasFeatureAtPixel(l);e("#mapContainer").css("cursor",a?"pointer":"");var s=t.map.forEachFeatureAtPixel(t.pixel,function(e){return e});if(s){var c=t.coordinate;if(s.get("features")&&1===s.get("features").length){var p=s.get("features")[0],u=p.getId().split("_");o.infoFn({type:u[0],content:p.get("featureData"),lng:c[0],lat:c[1]})}else{if(!s.get("featureData"))return;var y=s.getId().split("_");o.infoFn({type:y[0],content:s.get("featureData"),lng:c[0],lat:c[1]})}}else e(i).hide()}}},s.prototype.infoFn=function(t){var o,n=void 0;if(t.type&&"info"===t.type)n='<span style="color: white">'+t.content+"</span>";else if(t.type&&"tree"===t.type)n=function(e){console.log("OBJ"),console.log(e);var t=e.content;return'<ul type="none" style="margin: 0px;padding:0px;font-size:22px;" ><li>编号：'+(t.id||"无")+"</li><li>规格型号：DN65*2,"+t.hydrantTypeCanme+"</li><li>安装位置："+t.addressInfo+"</li></ul>"}(t);else if(t.type&&"fire"===t.type)n='<ul type="none" style="margin: 0px;padding:0px;font-size:22px;"><li>报警时间：'+((o=t.content).alarmTimeStr||"无")+"</li><li>报警等级："+(o.alarmLevelCname||"无")+"</li><li>报警类型："+(o.alarmTypeCname||"无")+"</li><li>报警位置："+(o.alarmAddress||"无")+"</li><li>报警描述："+(o.alarmDesc||"无")+'</li></ul><ul type="none" style="margin: 0px;padding:0 0 0 18px;font-size:22px;"  class="list_style_main"><li><input type="button"  value=派遣任务 onclick="fireDispatchFn()"></li><li><input type="button"  value=解除报警 onclick="fireCloseFn()"></li></ul>';else if(t.type&&"person"===t.type)n=function(e){var t=e.content;return'<ul type="none" style="margin: 0px;padding:0px;font-size: 22px"><li>姓   名：'+t.name+"</li><li>单   位："+t.dept+"</li><li>电   话："+t.PhoneNumber+"</li><li>位   置："+t.address+"</li></ul>"}(t);else{n='<span style="color: white;">'+t.lng+"</span>"}e(this.Info).html(n),e(this.Info).show(),this.InfoOverlay.setPosition([t.lng,t.lat])},s.prototype.coordinateLisen=function(e){var t=null,o=null,i=n.a.getters["scene/type"];if(console.log(window[i]),window[i]){t=window[i].coordinate_content,o=window[i].coordinate_overlay;var l=e.coordinate;ol.coordinate.toStringHDMS(ol.proj.toLonLat(l));t.innerHTML="经：<code>"+r(l[0])+"</code>,<br>纬：<code>"+r(l[1])+"</code>",console.log(l),o.setPosition(l)}},s.prototype.coordinateOnFn=function(){var t=this;e("body").append('\n        <div id="coordinate" class="ol-popup">\n            <a href="#" id="coordinate_closer" class="ol-popup-closer"></a>\n            <div id="coordinate_content"></div>\n        </div>\n    '),this.coordinate_container=document.getElementById("coordinate"),this.coordinate_content=document.getElementById("coordinate_content"),this.coordinate_closer=document.getElementById("coordinate_closer"),this.coordinate_overlay=new ol.Overlay({element:this.coordinate_container,autoPan:!0,autoPanAnimation:{duration:100}}),this.coordinate_closer.onclick=function(){return t.coordinate_overlay.setPosition(void 0),t.coordinate_closer.blur(),!1},this.map.addOverlay(this.coordinate_overlay),this.map.on("singleclick",this.coordinateLisen)},s.prototype.coordinateOffFn=function(){e("#coordinate").remove(),this.map.removeOverlay(this.coordinate_overlay),this.map.un("singleclick",this.coordinateLisen)},s.prototype.pointerMoveHandler=function(e){var t=null,o=null,r=null,i=null,l=null,a=n.a.getters["scene/type"];if(window[a]&&(l=window[a])&&(t=l.helpTooltipElement,o=l.helpTooltip,r=l.continuePolygonMsg,i=l.continueLineMsg,!e.dragging)){var s="点击测量";if(this.sketch){var c=this.sketch.getGeometry();c instanceof ol.geom.Polygon?s=r:c instanceof ol.geom.LineString&&(s=i)}t.innerHTML=s,o.setPosition(e.coordinate),t.classList.remove("hidden")}},s.prototype.formatLength=function(e){var t=ol.sphere.getLength(e,{projection:"EPSG:4326"});return t>100?Math.round(t/1e3*100)/100+" km":Math.round(100*t)/100+" m"},s.prototype.formatArea=function(e){var t=ol.sphere.getArea(e,{projection:"EPSG:4326"});return t>1e4?Math.round(t/1e6*100)/100+" km<sup>2</sup>":Math.round(100*t)/100+" m<sup>2</sup>"},s.prototype.addInteraction=function(e){var t=this,o="area"==e?"Polygon":"LineString";t.measure_draw=new ol.interaction.Draw({source:t.measureSource,type:o,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.4)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.5)",lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:6,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.8)"})})})}),this.map.addInteraction(t.measure_draw),this.createMeasureTooltip(),this.createHelpTooltip();var n=void 0;t.measure_draw.on("drawstart",function(e){t.sketch=e.feature;var o=e.coordinate;n=t.sketch.getGeometry().on("change",function(e){var n,r=e.target;r instanceof ol.geom.Polygon?(n=t.formatArea(r),o=r.getInteriorPoint().getCoordinates()):r instanceof ol.geom.LineString&&(n=t.formatLength(r),o=r.getLastCoordinate()),t.measureTooltipElement.innerHTML=n,t.measureTooltip.setPosition(o)})},this),t.measure_draw.on("drawend",function(){t.measureTooltipElement.className="emMeasure-tooltip emMeasure-tooltip-static",t.measureTooltip.setOffset([0,-7]),t.sketch=null,t.measureTooltipElement=null,t.createMeasureTooltip(),ol.Observable.unByKey(n)},this)},s.prototype.createHelpTooltip=function(){this.helpTooltipElement&&this.helpTooltipElement.parentNode.removeChild(this.helpTooltipElement),this.helpTooltipElement=document.createElement("div"),this.helpTooltipElement.className="emMeasure-tooltip hidden",this.helpTooltip=new ol.Overlay({element:this.helpTooltipElement,offset:[15,0],positioning:"center-left"}),this.helpTooltip_Overlays.push(this.helpTooltip),this.map.addOverlay(this.helpTooltip)},s.prototype.createMeasureTooltip=function(){this.measureTooltipElement&&this.measureTooltipElement.parentNode.removeChild(this.measureTooltipElement),this.measureTooltipElement=document.createElement("div"),this.measureTooltipElement.className="emMeasure-tooltip emMeasure-tooltip-measure",this.measureTooltip=new ol.Overlay({element:this.measureTooltipElement,offset:[0,-15],positioning:"bottom-center"}),this.measureTooltip_Overlays.push(this.measureTooltip),this.map.addOverlay(this.measureTooltip)},s.prototype.measureOn=function(e){this.map.on("pointermove",this.pointerMoveHandler),this.map.removeInteraction(this.measure_draw),this.addInteraction(e)},s.prototype.measureOff=function(){var e=this;this.helpTooltip_Overlays.forEach(function(t){e.map.removeOverlay(t)}),this.helpTooltip_Overlays=[],this.map.un("pointermove",this.pointerMoveHandler),this.map.removeInteraction(this.measure_draw)},s.prototype.measureClear=function(){var e=this;this.measureTooltip_Overlays.forEach(function(t){e.map.removeOverlay(t)}),this.measureTooltip_Overlays=[],this.measureSource.clear()},s.prototype.addFireFn=function(t,o){for(var n=this,r=this,i=function(t){e("body").append('<img id="fire_'+o[t].id+'" src="images/fire2d.gif" style="width:48px;height:58px;"/>');var i=document.getElementById("fire_"+o[t].id),l=new ol.Overlay({id:"fire_"+o[t].id,position:[o[t].lng,o[t].lat],offset:[-10,-32],element:i,className:"fire-overlay"});l.set("overlayData",o[t]),n.fireOverlays.push(l),n.map.addOverlay(l),e(l.getElement()).on("click",function(){var e=l.get("overlayData");r.fireObj=e,r.infoFn({type:"fire",content:e,lng:e.googleLang,lat:e.googleLat})}).on("mouseover",function(){e(this).css("cursor","pointer")})},l=0;l<o.length;l++)i(l)},s.prototype.clearOverlayFn=function(e){if(e&&e.length>0){for(var t=0;t<e.length;t++)this.map.removeOverlay(e[t]);this.fireOverlays=[]}},s.prototype.clearXfsExptionOverlayFn=function(){var e=this.xfsExptionOverlays;if(e&&e.length>0){for(var t=0;t<e.length;t++)this.map.removeOverlay(e[t]);this.xfsExptionOverlays=[]}}}).call(t,o("7t+N"))}});
//# sourceMappingURL=0.686a4ce2f5a8d1324a55.js.map